import React, { useState, useEffect } from 'react';
import { Search, Plus, X, Edit2, Trash2, Book, Headphones, Mic, Film, Tv, Star, Download, Upload, Check, Clock } from 'lucide-react';

const MediaTracker = () => {
  const [items, setItems] = useState([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedItem, setSelectedItem] = useState(null);
  const [isAdding, setIsAdding] = useState(false);
  const [editingItem, setEditingItem] = useState(null);
  const [filterType, setFilterType] = useState('all');
  const [filterGenre, setFilterGenre] = useState('all');
  const [filterStatus, setFilterStatus] = useState('all');
  const [filterCompletion, setFilterCompletion] = useState('all');

  const mediaTypes = ['Book', 'Audiobook', 'Podcast', 'Movie', 'TV Series'];
  const allGenres = [
    'Fiction', 'Non-Fiction', 'Sci-Fi', 'Fantasy', 'Mystery', 'Thriller',
    'Romance', 'Horror', 'Biography', 'History', 'Self-Help', 'Business',
    'Comedy', 'Drama', 'Documentary', 'Action', 'Adventure', 'Crime',
    'True Crime', 'Educational', 'Technology', 'Science', 'Entertainment',
    'Foreign-Language', 'Other'
  ];

  useEffect(() => {
    const stored = localStorage.getItem('mediaItems');
    if (stored) {
      setItems(JSON.parse(stored));
    }
  }, []);

  useEffect(() => {
    localStorage.setItem('mediaItems', JSON.stringify(items));
  }, [items]);

  const getMediaIcon = (type) => {
    const icons = {
      'Book': Book,
      'Audiobook': Headphones,
      'Podcast': Mic,
      'Movie': Film,
      'TV Series': Tv
    };
    return icons[type] || Book;
  };

  const handleAddItem = (newItem) => {
    setItems([...items, { ...newItem, id: Date.now() }]);
    setIsAdding(false);
  };

  const handleEditItem = (updatedItem) => {
    setItems(items.map(i => i.id === updatedItem.id ? updatedItem : i));
    setEditingItem(null);
    setSelectedItem(updatedItem);
  };

  const handleDeleteItem = (id) => {
    setItems(items.filter(i => i.id !== id));
    setSelectedItem(null);
  };

  const exportItems = () => {
    try {
      const dataStr = JSON.stringify(items, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `media-list-backup-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      alert('Backup downloaded successfully!');
    } catch (error) {
      alert('Error creating backup: ' + error.message);
    }
  };

  const importItems = (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const imported = JSON.parse(e.target.result);
          if (Array.isArray(imported)) {
            setItems(imported);
            alert('Media list imported successfully!');
          }
        } catch (error) {
          alert('Error importing list. Please check the file format.');
        }
      };
      reader.readAsText(file);
    }
  };

  const filteredItems = items.filter(item => {
    const matchesSearch = 
      item.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
      (item.notes && item.notes.toLowerCase().includes(searchQuery.toLowerCase())) ||
      (item.genres && item.genres.some(g => g.toLowerCase().includes(searchQuery.toLowerCase())));
    
    const matchesType = filterType === 'all' || item.type === filterType;
    const matchesGenre = filterGenre === 'all' || 
      (item.genres && item.genres.includes(filterGenre)) ||
      (item.genre && item.genre === filterGenre);
    const matchesStatus = filterStatus === 'all' || 
      (filterStatus === 'started' && item.started) ||
      (filterStatus === 'watchlist' && !item.started);
    const matchesCompletion = filterCompletion === 'all' ||
      (filterCompletion === 'finished' && item.finished) ||
      (filterCompletion === 'dnf' && item.started && !item.finished);

    return matchesSearch && matchesType && matchesGenre && matchesStatus && matchesCompletion;
  });

  const stats = {
    total: items.length,
    started: items.filter(i => i.started).length,
    finished: items.filter(i => i.finished).length,
    dnf: items.filter(i => i.started && !i.finished).length,
    watchlist: items.filter(i => !i.started).length
  };

  if (isAdding || editingItem) {
    return <MediaForm 
      item={editingItem}
      onSave={editingItem ? handleEditItem : handleAddItem}
      onCancel={() => {
        setIsAdding(false);
        setEditingItem(null);
      }}
      mediaTypes={mediaTypes}
      allGenres={allGenres}
    />;
  }

  if (selectedItem) {
    return <MediaDetail 
      item={selectedItem}
      onBack={() => setSelectedItem(null)}
      onEdit={() => {
        setEditingItem(selectedItem);
        setSelectedItem(null);
      }}
      onDelete={handleDeleteItem}
      getMediaIcon={getMediaIcon}
    />;
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-50 to-purple-50">
      <div className="bg-white shadow-sm sticky top-0 z-10">
        <div className="max-w-6xl mx-auto px-4 py-4">
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-3">
              <Film className="text-indigo-600" size={32} />
              <div>
                <h1 className="text-2xl font-bold text-gray-800">My Media List</h1>
                <p className="text-sm text-gray-500">
                  {stats.total} items · {stats.finished} finished · {stats.dnf} DNF · {stats.watchlist} watchlist
                </p>
              </div>
            </div>
            <div className="flex gap-2">
              <label className="cursor-pointer p-2 hover:bg-gray-100 rounded-lg transition-colors">
                <Upload size={20} className="text-gray-600" />
                <input type="file" accept=".json" onChange={importItems} className="hidden" />
              </label>
              <button 
                onClick={exportItems} 
                className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
                title="Download backup"
              >
                <Download size={20} className="text-gray-600" />
              </button>
              <button 
                onClick={() => setIsAdding(true)}
                className="bg-indigo-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-indigo-700 transition-colors"
              >
                <Plus size={20} />
                Add Item
              </button>
            </div>
          </div>

          <div className="space-y-3">
            <div className="relative">
              <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={20} />
              <input
                type="text"
                placeholder="Search by title, genre, or notes..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
              />
            </div>
            
            <div className="flex gap-2 overflow-x-auto pb-2">
              <select 
                value={filterStatus}
                onChange={(e) => setFilterStatus(e.target.value)}
                className="px-3 py-1 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
              >
                <option value="all">All Items</option>
                <option value="started">Started</option>
                <option value="watchlist">Watchlist</option>
              </select>

              <select 
                value={filterCompletion}
                onChange={(e) => setFilterCompletion(e.target.value)}
                className="px-3 py-1 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
              >
                <option value="all">All Status</option>
                <option value="finished">Finished</option>
                <option value="dnf">Did Not Finish</option>
              </select>

              <select 
                value={filterType}
                onChange={(e) => setFilterType(e.target.value)}
                className="px-3 py-1 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
              >
                <option value="all">All Types</option>
                {mediaTypes.map(type => <option key={type} value={type}>{type}</option>)}
              </select>
              
              <select 
                value={filterGenre}
                onChange={(e) => setFilterGenre(e.target.value)}
                className="px-3 py-1 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
              >
                <option value="all">All Genres</option>
                {allGenres.map(genre => <option key={genre} value={genre}>{genre}</option>)}
              </select>
            </div>
          </div>
        </div>
      </div>

      <div className="max-w-6xl mx-auto px-4 py-6">
        {filteredItems.length === 0 ? (
          <div className="text-center py-12">
            <Film size={64} className="mx-auto text-gray-300 mb-4" />
            <p className="text-gray-500 text-lg">
              {items.length === 0 ? 'No items yet. Add your first one!' : 'No items found matching your filters.'}
            </p>
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {filteredItems.map(item => (
              <MediaCard 
                key={item.id} 
                item={item} 
                onClick={() => setSelectedItem(item)}
                getMediaIcon={getMediaIcon}
              />
            ))}
          </div>
        )}
      </div>
    </div>
  );
};

const MediaCard = ({ item, onClick, getMediaIcon }) => {
  const Icon = getMediaIcon(item.type);
  
  const getStatusColor = () => {
    if (!item.started) return '#6366f1';
    if (item.finished) return '#10b981';
    return '#f59e0b';
  };

  const getStatusText = () => {
    if (!item.started) return 'Watchlist';
    if (item.finished) return 'Finished';
    return 'DNF';
  };
  
  return (
    <div 
      onClick={onClick}
      className="bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow cursor-pointer p-4 border-l-4"
      style={{ borderLeftColor: getStatusColor() }}
    >
      <div className="flex items-start justify-between mb-3">
        <div className="flex items-center gap-2">
          <Icon size={20} className="text-indigo-600" />
          <span className="text-xs font-medium text-gray-500">{item.type}</span>
        </div>
        <span className="text-xs font-medium px-2 py-1 rounded-full" style={{ 
          backgroundColor: getStatusColor() + '20',
          color: getStatusColor()
        }}>
          {getStatusText()}
        </span>
      </div>

      <h3 className="font-semibold text-lg text-gray-800 mb-1">{item.title}</h3>
      <p className="text-sm text-gray-500 mb-3">{item.year}</p>

      {(item.type === 'TV Series' || item.type === 'Podcast') && item.seasonsWatched && (
        <p className="text-xs text-gray-600 mb-2">
          Seasons: {item.seasonsWatched}
        </p>
      )}

      <div className="flex items-center justify-between mb-2">
        <div className="flex flex-wrap gap-1">
          {(item.genres || [item.genre]).filter(Boolean).slice(0, 3).map((genre, idx) => (
            <span key={idx} className="px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium">
              {genre}
            </span>
          ))}
        </div>
        {item.started && item.rating && (
          <div className="flex items-center gap-1">
            <Star size={14} className="text-yellow-500 fill-yellow-500" />
            <span className="text-sm font-semibold text-gray-700">{item.rating}/10</span>
          </div>
        )}
      </div>

      {item.started && item.notes && (
        <p className="mt-3 text-sm text-gray-600 line-clamp-2">
          {item.notes}
        </p>
      )}
    </div>
  );
};

const MediaDetail = ({ item, onBack, onEdit, onDelete, getMediaIcon }) => {
  const Icon = getMediaIcon(item.type);

  const getStatusBadge = () => {
    if (!item.started) {
      return { text: 'On Watchlist', color: 'bg-indigo-100 text-indigo-700' };
    }
    if (item.finished) {
      return { text: '✓ Finished', color: 'bg-green-100 text-green-700' };
    }
    return { text: 'Did Not Finish', color: 'bg-amber-100 text-amber-700' };
  };

  const statusBadge = getStatusBadge();

  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-50 to-purple-50">
      <div className="max-w-3xl mx-auto px-4 py-6">
        <div className="bg-white rounded-xl shadow-md p-6">
          <div className="flex justify-between items-start mb-6">
            <div className="flex items-center gap-3">
              <Icon size={32} className="text-indigo-600" />
              <div>
                <h1 className="text-3xl font-bold text-gray-800">{item.title}</h1>
                <p className="text-gray-500">{item.year}</p>
              </div>
            </div>
            <div className="flex gap-2">
              <button 
                type="button"
                onClick={(e) => {
                  e.stopPropagation();
                  onEdit();
                }} 
                className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
              >
                <Edit2 size={20} className="text-gray-600" />
              </button>
              <button 
                type="button"
                onClick={(e) => {
                  e.stopPropagation();
                  const confirmed = window.confirm('Are you sure you want to delete this item?');
                  if (confirmed) {
                    onDelete(item.id);
                  }
                }} 
                className="p-2 hover:bg-red-50 rounded-lg transition-colors"
              >
                <Trash2 size={20} className="text-red-600" />
              </button>
            </div>
          </div>

          <div className="flex flex-wrap gap-3 mb-6">
            <span className={`px-4 py-2 rounded-full text-sm font-medium ${statusBadge.color}`}>
              {statusBadge.text}
            </span>
            <span className="px-4 py-2 bg-purple-100 text-purple-700 rounded-full text-sm font-medium">
              {item.type}
            </span>
            {(item.genres || [item.genre]).filter(Boolean).map((genre, idx) => (
              <span key={idx} className="px-4 py-2 bg-gray-100 text-gray-700 rounded-full text-sm font-medium">
                {genre}
              </span>
            ))}
          </div>

          {(item.type === 'TV Series' || item.type === 'Podcast') && item.seasonsWatched && (
            <div className="mb-6">
              <h2 className="font-semibold text-lg text-gray-800 mb-2">Seasons Watched</h2>
              <p className="text-gray-700">{item.seasonsWatched}</p>
            </div>
          )}

          {item.started && item.rating && (
            <div className="mb-6">
              <h2 className="font-semibold text-lg text-gray-800 mb-3">My Rating</h2>
              <div className="flex items-center gap-2">
                <Star size={32} className="text-yellow-500 fill-yellow-500" />
                <span className="text-3xl font-bold text-gray-700">{item.rating}/10</span>
              </div>
            </div>
          )}

          {item.started && item.notes && (
            <div className="mb-6">
              <h2 className="font-semibold text-lg text-gray-800 mb-3">My Notes</h2>
              <div className="bg-gray-50 rounded-lg p-4 whitespace-pre-wrap text-gray-700">
                {item.notes}
              </div>
            </div>
          )}

          {!item.started && (
            <div className="mb-6 p-4 bg-indigo-50 rounded-lg">
              <p className="text-indigo-700">
                This item is on your watchlist. Mark it as started to add a rating and notes.
              </p>
            </div>
          )}

          <button 
            onClick={onBack}
            className="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition-colors font-medium"
          >
            Back to List
          </button>
        </div>
      </div>
    </div>
  );
};

const MediaForm = ({ item, onSave, onCancel, mediaTypes, allGenres }) => {
  const [formData, setFormData] = useState(item || {
    title: '',
    year: new Date().getFullYear().toString(),
    type: 'Movie',
    genres: [],
    started: false,
    finished: false,
    rating: null,
    notes: '',
    seasonsWatched: ''
  });

  const toggleGenre = (genre) => {
    const currentGenres = formData.genres || [];
    if (currentGenres.includes(genre)) {
      setFormData({ ...formData, genres: currentGenres.filter(g => g !== genre) });
    } else if (currentGenres.length < 3) {
      setFormData({ ...formData, genres: [...currentGenres, genre] });
    }
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (formData.title && formData.year && (formData.genres || []).length > 0) {
      onSave(formData);
    } else {
      alert('Please fill in title, year, and select at least one genre');
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-50 to-purple-50 py-6">
      <div className="max-w-3xl mx-auto px-4">
        <div className="bg-white rounded-xl shadow-md p-6">
          <h2 className="text-2xl font-bold text-gray-800 mb-6">
            {item ? 'Edit Item' : 'Add New Item'}
          </h2>
          
          <div className="space-y-6">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Title *</label>
              <input
                type="text"
                value={formData.title}
                onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                placeholder="e.g., The Shawshank Redemption"
              />
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Year *</label>
                <input
                  type="text"
                  value={formData.year}
                  onChange={(e) => setFormData({ ...formData, year: e.target.value })}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  placeholder="e.g., 1994"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Type</label>
                <select
                  value={formData.type}
                  onChange={(e) => setFormData({ ...formData, type: e.target.value })}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                >
                  {mediaTypes.map(type => <option key={type} value={type}>{type}</option>)}
                </select>
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Genres (select up to 3)
              </label>
              <div className="border border-gray-300 rounded-lg p-3 max-h-48 overflow-y-auto">
                <div className="grid grid-cols-2 gap-2">
                  {allGenres.map(genre => {
                    const isSelected = (formData.genres || []).includes(genre);
                    const isDisabled = !isSelected && (formData.genres || []).length >= 3;
                    return (
                      <button
                        key={genre}
                        type="button"
                        onClick={() => toggleGenre(genre)}
                        disabled={isDisabled}
                        className={`px-3 py-2 rounded-lg text-sm text-left transition-colors ${
                          isSelected
                            ? 'bg-purple-600 text-white'
                            : isDisabled
                            ? 'bg-gray-100 text-gray-400 cursor-not-allowed'
                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                        }`}
                      >
                        {genre}
                      </button>
                    );
                  })}
                </div>
              </div>
              <p className="text-xs text-gray-500 mt-1">
                Selected: {(formData.genres || []).length}/3
              </p>
            </div>

            <div>
              <label className="flex items-center gap-2 cursor-pointer">
                <input
                  type="checkbox"
                  checked={formData.started}
                  onChange={(e) => setFormData({ 
                    ...formData, 
                    started: e.target.checked,
                    finished: e.target.checked ? formData.finished : false
                  })}
                  className="w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
                />
                <span className="text-sm font-medium text-gray-700">I've started this</span>
              </label>
            </div>

            {formData.started && (
              <>
                <div>
                  <label className="flex items-center gap-2 cursor-pointer">
                    <input
                      type="checkbox"
                      checked={formData.finished}
                      onChange={(e) => setFormData({ ...formData, finished: e.target.checked })}
                      className="w-5 h-5 text-green-600 border-gray-300 rounded focus:ring-green-500"
                    />
                    <span className="text-sm font-medium text-gray-700">I finished this</span>
                  </label>
                  {!formData.finished && formData.started && (
                    <p className="text-xs text-amber-600 mt-1 ml-7">
                      (Leave unchecked for "Did Not Finish")
                    </p>
                  )}
                </div>

                {(formData.type === 'TV Series' || formData.type === 'Podcast') && (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Seasons Watched
                    </label>
                    <input
                      type="text"
                      value={formData.seasonsWatched || ''}
                      onChange={(e) => setFormData({ ...formData, seasonsWatched: e.target.value })}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                      placeholder="e.g., Season 1-3, All seasons, S1-S2"
                    />
                  </div>
                )}

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Rating (1-10, decimals allowed)
                  </label>
                  <input
                    type="number"
                    min="1"
                    max="10"
                    step="0.1"
                    value={formData.rating || ''}
                    onChange={(e) => {
                      const value = e.target.value;
                      if (value === '') {
                        setFormData({ ...formData, rating: null });
                      } else {
                        const numValue = parseFloat(value);
                        if (numValue >= 1 && numValue <= 10) {
                          setFormData({ ...formData, rating: numValue });
                        }
                      }
                    }}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    placeholder="e.g., 8.6"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">My Notes</label>
                  <textarea
                    value={formData.notes}
                    onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                    rows={6}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    placeholder="What did you think? Any memorable moments or thoughts..."
                  />
                </div>
              </>
            )}

            <div className="flex gap-3">
              <button
                type="button"
                onClick={handleSubmit}
                className="flex-1 bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition-colors font-medium"
              >
                {item ? 'Update Item' : 'Save Item'}
              </button>
              <button
                type="button"
                onClick={onCancel}
                className="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg hover:bg-gray-300 transition-colors font-medium"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default MediaTracker;
